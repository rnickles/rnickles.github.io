---
layout: default
title: Game
---

<script src="game/matter.min.js"></script>

<script type="module">

import { init_level1 } from './game/levels/level1.js'
import { init_level2 } from './game/levels/level2.js'
import { UserPlatform } from './game/objects/platform.js'
import { Ball } from './game/objects/ball.js'

// create an engine
var engine = Matter.Engine.create();

let MAX_LEVEL = 2;
var current_level = 1;
var game_state = {  
    level_complete: false,
    goal: null,
};

// create a renderer
var render = Matter.Render.create({
    element: document.body,
    engine: engine,
    options: {wireframes: false}
});

init_level1(Matter, engine, game_state);

// run the renderer
Matter.Render.run(render);

// accept user input
var startX, startY, endX, endY;

function getCoordinates(event) {
    if (event.touches) {
        return {
            x: event.touches[0].clientX,
            y: event.touches[0].clientY
        };
    } else {
        return {
            x: event.clientX,
            y: event.clientY
        };
    }
}

document.addEventListener('mousedown', function(event) {
    const coords = getCoordinates(event);
    startX = coords.x;
    startY = coords.y;
});

document.addEventListener('mouseup', function(event) {
    const coords = getCoordinates(event);
    endX = coords.x;
    endY = coords.y;
    new UserPlatform(startX, startY, endX, endY, engine, Matter);
});

document.addEventListener('touchstart', function(event) {
    const coords = getCoordinates(event);
    startX = coords.x;
    startY = coords.y;
});

document.addEventListener('touchend', function(event) {
    const coords = getCoordinates(event.changedTouches[0]);
    endX = coords.x;
    endY = coords.y;
    new UserPlatform(startX, startY, endX, endY, engine, Matter);
});

let lastBallDrop = Date.now();

function update() {
    if (Date.now() - lastBallDrop >= 3000) {
        let ball = new Ball(450, 50, engine, Matter);
        game_state.goal.addDetector(ball);
        lastBallDrop = Date.now();
    }

    game_state.goal.update();

    if (game_state.level_complete == true) {
        game_state.level_complete = false;
        current_level += 1;
        if (current_level > MAX_LEVEL) {
            console.log("woot! game over!"); 
            return;
        }
        // Restart the engine and renderer to an intial state
        Matter.World.clear(engine.world, false);
        Matter.Engine.clear(engine);
        Matter.Render.stop(render);
        render.canvas.parentNode.removeChild(render.canvas);
        render = Matter.Render.create({
            element: document.body,
            engine: engine,
            options: {wireframes: false}
        });

        if (current_level == 2) {
            console.log("level 1 passed; level 2 loading");
            init_level2(Matter, engine, game_state)
        }

        // Restart the renderer
        Matter.Render.run(render);
    }

    Matter.Engine.update(engine, 1000 / 60 );
    requestAnimationFrame(update);
}

// run the engine
requestAnimationFrame(update);

</script>
